@using AspnetCoreMvcFull.Models.Mensajes
@{
    ViewData["Title"] = "Control de Tráfico";
}

<link href="~/css/controTrafico.css" rel="stylesheet" />

<div class="card" style="padding: 1rem 1rem 1rem 1rem;">
    <!-- Form GET sólo para búsqueda (puede ir al inicio de la vista) -->
    <form id="frmSearch" method="get" action="@Url.Action("ControlTrafico")"></form>

    <form id="frmControlTrafico" asp-controller="GestionServicio" asp-action="InsertarControTrafico" method="post">
        <input type="hidden" id="EstadoFormulario" name="EstadoFormulario" value="Insertar" />
        <input type="hidden" name="ticket" value="" />
        <!-- Header alineado -->
        <div class="row align-items-center g-2 mb-3">
            <!-- Izquierda: título -->
            <div class="col-12 col-md-auto">
                <h4 class="mb-0" style="color:#606060">Control de Tráfico</h4>
            </div>

            <!-- Derecha: checks -->
            <div class="col-12 col-md">
                <div id="channelGroup"
                     class="channel-checks d-flex flex-wrap gap-3 justify-content-md-end justify-content-center">
                    <label>
                        <input class="chx-canal" type="checkbox" name="CanalEmail" value="true" style="accent-color:#ff5100;">
                        <input type="hidden" name="CanalEmail" value="false" /> Email
                    </label>
                    <label>
                        <input class="chx-canal" type="checkbox" name="CanalWeb" value="true" style="accent-color:#ff5100;">
                        <input type="hidden" name="CanalWeb" value="false" /> Web
                    </label>
                    <label>
                        <input class="chx-canal" type="checkbox" name="CanalPresencial" value="true" style="accent-color:#ff5100;">
                        <input type="hidden" name="CanalPresencial" value="false" /> Presencial
                    </label>
                    <label>
                        <input class="chx-canal" type="checkbox" name="CanalTelefono" value="true" style="accent-color:#ff5100;">
                        <input type="hidden" name="CanalTelefono" value="false" /> Teléfono
                    </label>
                    <label>
                        <input class="chx-canal" type="checkbox" name="CanalChatbot" value="true" style="accent-color:#ff5100;">
                        <input type="hidden" name="CanalChatbot" value="false" /> Chatbot
                    </label>
                </div>
                <!-- error de canales -->
                <div id="canalesError" class="field-error"></div>
            </div>
        </div>



        <!-- Grid -->
        <div class="traffic-grid">
            <!-- Fila 1 -->
            <div class="row gx-3 gy-3 align-items-start">


                <!-- Empresa -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <label class="form-label" style="color:#606060">Empresa*</label>
                        <select name="EmpresaId" id="selectEmpresa" class="form-select select-light">
                            <option value="" selected disabled>Seleccione un elemento</option>
                        </select>
                        <div id="empresaError" class="field-error"></div>
                    </div>

                </div>


                <!-- Contrato (NO requerido) -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <label style="color:#606060" class="form-label">Contrato Número</label>
                        <select name="ContratoId" id="selectContrato" class="form-select select-light">
                            <option value="">Sin contrato</option>
                        </select>
                        <div id="contratoError" class="field-error"></div>
                    </div>
                </div>

                <!-- Buscador -->
                <!-- Buscador -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <label style="visibility:hidden">Buscar</label>
                        <div class="row g-2 align-items-end">
                            <div class="col">
                                <input form="frmSearch" type="text" name="q" class="traffic-input"
                                       placeholder="Buscar" value="@(Model?.Query ?? "")" />
                                <input form="frmSearch" type="hidden" name="page" value="1" />
                                <input form="frmSearch" type="hidden" name="pageSize" value="@Model.PageSize" />
                            </div>
                            <div class="col-auto">
                                <button form="frmSearch" type="submit" class="btn-primary-ux" style="min-width:120px">Buscar</button>
                            </div>
                        </div>
                        <!-- 🔽 placeholder para mantener altura igual que las demás -->
                        <div class="field-error">&nbsp;</div>
                    </div>
                </div>
            </div>


            <!-- Fila 2 -->
            <div class="row gx-3 gy-3">

                <!-- Solicitante -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <label style="color:#606060" class="form-label">Solicitante*</label>
                        <select name="SolicitanteId" id="selectSolicitante" class="form-select select-light">
                            <option value="">Seleccione un elemento</option>
                            @foreach (var opt in (IEnumerable<SelectListItem>)ViewBag.Solicitantes)
                            {
                                <option value="@opt.Value">@opt.Text</option>
                            }
                        </select>
                        <div id="solicitanteError" class="field-error"></div>
                    </div>
                </div>

                <!-- Tel + Email -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <div class="tel-email">
                            <div class="field-half">
                                <label class="form-label" style="color:#606060">Tel para el Servicio*</label>
                                <input name="TelefonoServicio" id="TelefonoServicio" class="traffic-input" />
                                <div id="telefonoEmailError" class="field-error"></div>
                            </div>

                            <div class="field-half">
                                <label class="form-label" style="color:#606060">Email para el Servicio*</label>
                                <input name="EmailServicio" id="EmailServicio" class="traffic-input" />
                                <div id="telefonoEmailError2" class="field-error"></div>
                            </div>
                        </div>
                        <!-- 🔻 elimina este si lo tenías aquí fuera -->
                        <!-- <div id="telefonoEmailError" class="field-error"></div> -->
                    </div>
                </div>


                <!-- Asignado -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <label class="form-label" style="color:#606060">Asignar Incidente a:</label>
                        <select name="AsignadoAId" id="selectAsignado" class="form-select select-light">
                            <option value="" selected disabled>Seleccione un elemento</option>
                            @foreach (var opt in (IEnumerable<SelectListItem>)ViewBag.Asignados)
                            {
                                <option value="@opt.Value">@opt.Text</option>
                            }
                        </select>
                        <div id="asignadoError" class="field-error"></div>
                    </div>

                </div>
                <script>
                    document.addEventListener('DOMContentLoaded', () => {
                      const estado = document.getElementById('EstadoFormulario')?.value || 'Insertar';
                      const sel = document.getElementById('selectAsignado');
                      if (estado === 'Insertar' && sel) {
                        const opt = [...sel.options].find(o => o.text.trim().toLowerCase().startsWith('sin asignar'));
                        if (opt) sel.value = opt.value;
                      }
                    });
                </script>

            </div>

            <!-- Fila 3 -->
            <div class="row gx-3 gy-3">
                <!-- Razón de Servicios (md-4) -->
                <div class="col-12 col-md-4">
                    <div class="field-wrap">
                        <label style="color:#606060" class="form-label">Razón de Servicios*</label>
                        <select name="RazonServicioId" id="selectRazonServicio" class="form-select select-light">
                            <option value="" selected disabled>Seleccione un elemento</option>
                            @foreach (var opt in (IEnumerable<SelectListItem>)ViewBag.RazonesServicio)
                            {
                                <option value="@opt.Value">@opt.Text</option>
                            }
                        </select>
                        <div id="razonError"></div>
                    </div>


                </div>


                <!-- Lugar de Servicio (md-2) -->
                <div class="col-12 col-md-2">
                    <div class="field-wrap">
                        <label class="form-label" style="color:#606060">Lugar de Servicio*</label>

                        <div class="inline-checks inline-eq">
                            <label class="radio-square">
                                <input type="radio" name="LugarServicio" value="0" checked>
                                <span>Remoto</span>
                            </label>

                            <label class="radio-square">
                                <input type="radio" name="LugarServicio" value="1">
                                <span>Presencial</span>
                            </label>
                        </div>
                        <div id="lugarServicioError"></div>

                    </div>

                </div>


                <!-- Dirección para el Servicio (md-6) -->
                <div class="col-12 col-md-6">
                    <div class="field-wrap">
                        <label style="color:#606060" class="form-label">Dirección para el Servicio</label>
                        <textarea name="DireccionServicio" id="DireccionServicio" class="traffic-textarea"></textarea>
                        <div id="direccionError"></div>
                    </div>


                </div>
            </div>


            <!-- Fila 4 (todo alineado como la segunda imagen) -->
            <div class="row gx-3 gy-3">
                <!-- Columna izquierda: Fecha + Hora (apilados) -->
                <div class="col-12 col-md-4">

                    <!-- Fecha Próximo Servicio -->
                    <div class="field-wrap">
                        <label class="form-label" style="color:#606060">Fecha Próximo Servicio</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text"
                                   class="traffic-input"
                                   id="FechaProximoServicio"
                                   name="FechaProximoServicio"
                                   placeholder="mm/dd/yy"
                                   readonly />

                            <button class="btn btn-outline-orange d-inline-flex align-items-center justify-content-center"
                                    type="button" id="btnCalendarioServicio"
                                    style="min-width:52px; height:44px; padding:0 12px; border-radius:12px;">
                                <img src="@Url.Content("~/img/calendario_icono.svg")" alt="Calendario" width="20" height="20" />
                            </button>
                        </div>
                        <div id="fechaError" class="field-error"></div>
                    </div>

                    <!-- Hora + flags (misma anchura total que arriba) -->
                    <div class="field-wrap mt-3">
                        <label class="form-label" style="color:#606060">Hora para el Servicio</label>

                        <div class="row g-2 align-items-end">
                            <!-- Select hora -->
                            <div class="col-12 col-sm-6 col-lg-7">
                                <select name="HoraServicio" id="HoraServicio"
                                        class="form-select time-select"
                                        data-selected="@ViewBag.HoraServicio">
                                    <option value="">hh:mm</option>
                                </select>
                                <!-- error de hora -->
                                <div id="horaError" class="field-error"></div>
                            </div>

        
                            <!-- Checkboxes (GD / SC / S-ID) -->
                            <!-- Checkboxes (GD / SC / S-ID) -->
                            <div class="col-12 col-sm-6 col-lg-5">
                                <div class="hour-flags d-flex w-100 align-items-center gap-2 gap-sm-3 px-3 rounded-3
            flex-wrap flex-sm-nowrap justify-content-start ms-md-2 ms-lg-3">
                                    <label class="mb-0 d-flex align-items-center gap-2">
                                        <input type="checkbox" name="GD" value="true" style="accent-color:#ff5100;" id="flagGD">
                                        <input type="hidden" name="GD" value="false" />GD
                                    </label>

                                    <label class="mb-0 d-flex align-items-center gap-2">
                                        <input type="checkbox" name="SC" value="true" style="accent-color:#ff5100;" id="flagSC">
                                        <input type="hidden" name="SC" value="false" />SC
                                    </label>

                                    <!-- OJO: sin ms-md-auto -->
                                    <label class="mb-0 d-flex align-items-center gap-2">
                                        <input type="checkbox" name="SID" value="true" style="accent-color:#ff5100;" id="flagSID">
                                        <input type="hidden" name="SID" value="false" />S-ID
                                    </label>
                                </div>

                                <div id="proveedorError" class="field-error mt-1"></div>
                            </div>
                

                        </div>
                    </div>

                </div>
                <style>
                    .hour-flags {
                        flex-wrap: nowrap !important; /* no permitir saltos */
                        min-width: 0; /* evita desbordes raros */
                    }

                        .hour-flags label {
                            white-space: nowrap; /* que cada etiqueta no haga wrap */
                            flex: 0 0 auto; /* no intentar expandirse */
                        }

                </style>
                <!-- Columna derecha: Descripción -->
                <div class="col-12 col-md-8">
                    <div class="field-wrap">
                        <label class="form-label" style="color:#606060">Descripción de Incidente</label>
                        <textarea name="DescripcionIncidente" id="DescripcionIncidente"
                                  class="traffic-textarea" style="min-height:130px;"></textarea>
                        <div id="descripcionError" class="field-error"></div>
                    </div>
                </div>
            </div>


            <!-- Fila de botones (solo botones centrados) -->
            <div class="row g-3 mt-3">
                <div class="col-12 d-flex justify-content-center">
                    <div class="d-flex justify-content-center gap-3">
                        <button type="submit" class="btn-primary-ux btn-ux-sm">Guardar</button>
                        <button type="button" id="btnBorrar" class="btn-secondary-ux btn-ux-sm">Borrar</button>
                    </div>
                </div>
            </div>

        </div>
    </form>


    <style>
        /* Cabecera: título a la izq, canales a la der */
        .traffic-head2 {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .channel-checks {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Solo texto de error (sin iconos ni bordes) */
        .error-text {
            position: static;
        }

        /* Mensaje de error de canales: fijo arriba a la derecha,
                                                     no mueve el grupo de checkboxes */
        .field-wrap {
            display: flex;
            flex-direction: column;
        }

        .field-error {
            position: static;
            margin-top: 4px;
            font-size: 12px;
            line-height: 1.2;
            color: #e53935;
            min-height: 16px; /* reserva alto aunque esté vacío */
        }

        /* Para el header de canales, unifícalo a .field-error para reservar alto */
        #canalesError {
            text-align: right; /* en desktop queda alineado a la derecha */
        }

        /* (Opcional) si quieres que Tel/Email no desacomode nada */
        .tel-email {
            display: flex;
            gap: 12px;
        }

        .field-half {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Solo encabezados */
        .table thead th {
            white-space: normal !important; /* permite salto de línea */
            overflow: visible !important;
            text-overflow: clip !important;
            overflow-wrap: anywhere; /* rompe palabras largas si hace falta */
        }

    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const group = document.querySelector('.hour-flags');
          if (!group) return;

          // todos los checkboxes del grupo (GD, SC, SID)
          const checks = group.querySelectorAll('input[type="checkbox"]');

          // helper: pone en false los hidden del resto
          function setHiddenFalse(exceptName) {
            checks.forEach(chk => {
              if (chk.name !== exceptName) {
                const hid = chk.parentElement.querySelector(`input[type="hidden"][name="${chk.name}"]`);
                if (hid) hid.value = 'false';
              }
            });
          }

          checks.forEach(chk => {
            chk.addEventListener('change', () => {
              if (chk.checked) {
                // si este se marca, desmarco todos los demás
                checks.forEach(other => {
                  if (other !== chk) {
                    other.checked = false;
                  }
                });
                setHiddenFalse(chk.name);
                // tip: no cambiamos el hidden "de este", el binder tomará el true del checkbox
              } else {
                // se permitió dejar los tres desmarcados (ninguno seleccionado)
                // si quisieras forzar que siempre haya uno, vuelve a marcarlo:
                // chk.checked = true;
              }
            });
          });
        });
    </script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetch('@Url.Content("~/GestionServicio/ObtenerEmpresasService")')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('selectEmpresa');
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.texto;
                        select.appendChild(option);
                    });
                });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const selectA = document.getElementById('selectEmpresa');
            const selectB = document.getElementById('selectContrato');

            selectA.addEventListener('change', function () {
                const companyId = this.value;

                // Reset y deshabilita el select B
                selectB.innerHTML = '<option value="">Seleccione un elemento</option>';
                //selectB.disabled = true;

                if (companyId) {
                    fetch(`@Url.Content("~/GestionServicio/ObtenerContratosServices")?idCompany=${companyId}`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.id;
                                option.textContent = item.texto;
                                selectB.appendChild(option);
                            });
                            //selectB.disabled = false;
                        });
                }
            });
        });
    </script>

    <script>
        async function cargarContratosService(ubicacionA, ubicacionB) {
            const selectA = document.getElementById('selectEmpresa');
            const selectB = document.getElementById('selectContrato');


            // Asignar A y cargar B
            selectA.value = ubicacionA;
            await fetch(`@Url.Content("~/GestionServicio/ObtenerContratosServices")?idCompany=${ubicacionA}`)
                .then(response => response.json())
                .then(data => {
                    selectB.innerHTML = '<option value="">Seleccione un elemento</option>';
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.texto;
                        selectB.appendChild(option);
                    });
                    selectB.value = ubicacionB;
                });



        }
    </script>


    <br />
    @model AspnetCoreMvcFull.Models.Common.PagedResult<AspnetCoreMvcFull.Models.Contro_de_Trafico.ControlTraficoPostDto>

    <style>

        .select-light {
            background-color: #eeeeee;
        }
    </style>

    <form asp-controller="GestionServicio" asp-action="ControlTrafico" method="get">
        <div class="card-datatable table-responsive border" style="padding: .5rem;">
            <style>
                .card-datatable {
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    overflow: hidden;
                    background: #fff
                }

                    .card-datatable table {
                        border-bottom: 1px solid #dee2e6
                    }
                /* ancho y centrado del checkbox */
                .w-5 {
                    width: 5%
                }

                .w-10 {
                    width: 10%
                }

                .w-20 {
                    width: 20%
                }

                .w-35 {
                    width: 35%
                }

                .w-50 {
                    width: 50%
                }

                .text-center {
                    text-align: center
                }

                table th,
                table td {
                    white-space: nowrap; /* No permite saltos de línea dentro de la celda */
                    overflow: visible !important;
                    text-overflow: unset !important;
                    max-width: none !important; /* Evita que se limite el ancho */
                }

                .table-responsive {
                    overflow-x: auto;
                }

            </style>
            <div class="table-responsive table-scroll">
                <table class="datatables-basic table table-stretch">
                    <thead>
                        <tr>
                            <th>Número de contrato</th>
                            <th>Razón del servicio</th>
                            <th>Proveedor</th>
                            <th>Fecha</th>
                            <th>Asignado</th>
                            <th>N ticket</th>
                            <th>Fecha próximo servicio</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Items != null && Model.Items.Any())
                        {
                            foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td style="font-size:12.5px" class="text-truncate">@item.ContratoId</td>
                                    <td style="font-size:12.5px" class="d-none d-sm-table-cell text-truncate">@item.RazonServicioId</td>
                                    <td style="font-size:12.5px" class="d-none d-sm-table-cell text-truncate">@item.Proveedor</td>
                                    <td style="font-size:12.5px" class="d-none d-md-table-cell text-truncate">@item.Fecha</td>
                                    <td style="font-size:12.5px" class="d-none d-lg-table-cell text-truncate">@item.AsignadoAId</td>
                                    <td style="font-size:12.5px" class="d-none d-sm-table-cell">@item.ticket</td>
                                    <td style="font-size:12.5px" class="d-none d-md-table-cell text-truncate">@item.FechaProximoServicio</td>
                                    <td class="text-end">
                                        <div class="d-inline-flex gap-2">
                                            <a class="btn btn-edit d-flex align-items-center justify-content-center p-1 px-2"
                                               title="Editar"
                                               data-contrato="@item.ContratoId"
                                               data-ticket="@item.ticket"
                                               style="background-color:#00A5B8;border:none;border-radius:6px;height:28px;min-width:40px;">
                                                <img src="~/img/editar_icono.svg" alt="Editar" style="width:16px;height:16px;">
                                            </a>
                                            <button type="button" class="btn d-flex align-items-center justify-content-center p-1 px-2"
                                                    title="Borrar"
                                                    data-bs-toggle="modal" data-bs-target="#trafficDeleteModal"
                                                    data-contrato="@item.ContratoId"
                                                    data-ticket="@item.ticket"
                                                    style="background-color:#666;border:none;border-radius:6px;height:28px;min-width:40px;">
                                                <img src="~/img/eliminar_icono.svg" alt="Eliminar" style="width:16px;height:16px;">
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">Sin resultados.</td>
                            </tr>
                        }
                    </tbody>

                </table>
            </div>


            @{
                var page = Model.CurrentPage;
                var pageSize = Model.PageSize;
                var total = Model.TotalItems;
                var totalPages = Model.TotalPages;
                var q = Model.Query ?? "";
            }

            <!-- Pie: info + paginación SIEMPRE visible -->
            <div class="d-flex justify-content-end mt-2">
                <nav aria-label="Paginación">
                    <ul class="pagination flex-wrap mb-0">
                        <li class="page-item @(page == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("ControlTrafico", new { page = 1, pageSize, q })">««</a>
                        </li>
                        <li class="page-item @(page == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("ControlTrafico", new { page = Math.Max(1, page - 1), pageSize, q })">«</a>
                        </li>

                        @for (var i = 1; i <= totalPages; i++)
                        {
                            if (totalPages == 1 || i == 1 || i == totalPages || (i >= page - 2 && i <= page + 2))
                            {
                                <li class="page-item @(i == page ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("ControlTrafico", new { page = i, pageSize, q })">@i</a>
                                </li>
                            }
                            else if (i == page + 3 || i == page - 3)
                            {
                                <li class="page-item disabled"><span class="page-link">…</span></li>
                            }
                        }

                        <li class="page-item @(page >= totalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("ControlTrafico", new { page = Math.Min(totalPages, page + 1), pageSize, q })">»</a>
                        </li>
                        <li class="page-item @(page >= totalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("ControlTrafico", new { page = totalPages, pageSize, q })">»»</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </form>
</div>

<!-- Modal específico Control de Tráfico -->
<div class="modal fade" id="trafficDeleteModal"
     tabindex="-1" aria-labelledby="trafficDeleteLabel" aria-hidden="true"
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <!-- sin modal-dialog-centered -->
        <div class="modal-content" style="border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title" id="trafficDeleteLabel">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <p class="mb-1">¿Seguro que deseas eliminar este registro?</p>
                <small class="text-muted d-block">Contrato: <span id="trafDelContratoText">—</span></small>
                <small class="text-muted d-block">Ticket: <span id="trafDelTicketText">—</span></small>
            </div>

            <div class="modal-footer">
                <form asp-controller="GestionServicio" asp-action="EliminarControlTrafico" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ticket" id="trafDelTicketInput" value="">
                    <button type="submit" id="trafConfirmDeleteBtn" class="btn btn-danger">Eliminar</button>
                </form>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

            </div>
        </div>
    </div>
</div>



@{
    AlertMessage? alertMessage = null;

    if (TempData["Alert"] is string alertJson)
    {
        try
        {
            alertMessage = System.Text.Json.JsonSerializer.Deserialize<AlertMessage>(alertJson);
            TempData.Remove("Alert");
        }
        catch { alertMessage = null; }
    }
}

@if (alertMessage != null)
{
    var jsonAlert = Json.Serialize(alertMessage); // serializa para usarlo en JS

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var alertData = @Html.Raw(jsonAlert);
            console.log("SCRIPT DE ALERTA ACTIVADO");
            console.log(alertData);

            var deleteModal = document.getElementById('deleteModal');
            var deleteModalLabel = document.getElementById('deleteModalLabel');
            var deleteModalBody = document.getElementById('deleteModalBody');
            var confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            var modalHeader = deleteModal.querySelector('.modal-header');

            deleteModalLabel.textContent = (alertData.tipo.toLowerCase() === "success") ? "Éxito" : "Error";
            deleteModalBody.innerHTML = alertData.mensaje;

            // Aplicar colores por defecto según tipo
            if (alertData.tipo.toLowerCase() === "success") {
                modalHeader.style.backgroundColor = "transparent";
                deleteModalLabel.style.color = "#606060";
            } else {
                modalHeader.style.backgroundColor = "#FF5100";
                deleteModalLabel.style.color = "white";
            }

            confirmDeleteBtn.classList.add('d-none');

            var modal = new bootstrap.Modal(deleteModal);
            modal.show();

            deleteModal.addEventListener('hidden.bs.modal', function () {
                history.replaceState(null, '', window.location.pathname);
            });
        });
    </script>

}

<!-- Modal de confirmación -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                <!-- Este texto se actualizará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a id="confirmDeleteBtn" class="btn btn-danger d-none" href="#">Borrar</a>
            </div>
        </div>
    </div>
</div>


<script>
    (() => {
      // ===================== Helpers comunes =====================
      const $ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$ = (sel, ctx=document) => [...ctx.querySelectorAll(sel)];

      function setSelectValueSafe(selectEl, value) {
        if (!selectEl) return;
        if (!value) { selectEl.value = ''; return; }
        selectEl.value = value;                          // intento exacto
        if (selectEl.value === value) return;
        const v = String(value).trim().toLowerCase();    // intento case-insensitive
        const opt = [...selectEl.options].find(o => String(o.value).trim().toLowerCase() === v);
        if (opt) { opt.selected = true; return; }
        selectEl.value = '';                              // no existe -> queda vacío
      }

      async function cargarContratosService(empresaId, selectedValue) {
        const selContrato = $('#selectContrato');
        if (!selContrato) return;

        // siempre dejar "Sin contrato" al inicio
        selContrato.innerHTML = '';
        selContrato.append(new Option('Sin contrato', ''));

        if (!empresaId) { selContrato.value = ''; return; }

        const url = '@Url.Action("ContratosPorEmpresa", "GestionServicio")' + '?empresaId=' + encodeURIComponent(empresaId);
        const res = await fetch(url, { headers: { 'Accept':'application/json' } });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json(); // [{value,text}]
        data.forEach(o => selContrato.append(new Option(o.text, o.value)));

        if (selectedValue) setSelectValueSafe(selContrato, selectedValue);
        dedupeSelect(selContrato);
      }

      function ensureTimeOptions() {
        const sel = $('#HoraServicio');
        if (!sel || sel.dataset.populated === '1') return;
        const step = 15;
        for (let h = 0; h < 24; h++) {
          for (let m = 0; m < 60; m += step) {
            const hh = String(h).padStart(2, '0');
            const mm = String(m).padStart(2, '0');
            sel.add(new Option(`${hh}:${mm}`, `${hh}:${mm}`));
          }
        }
        sel.dataset.populated = '1';
      }

      function setTimeSelectValue(val) {
        const sel = $('#HoraServicio');
        ensureTimeOptions();
        if (!val) { sel.value = ''; return; }
        sel.value = val;
        if (sel.value !== val) { // no existe → agregar
          sel.add(new Option(val, val), 1);
          sel.value = val;
        }
      }

      function setDateField(inputId, ymd, { allowPast=false } = {}) {
        const el = document.getElementById(inputId);
        if (!el) return;
        if (el._flatpickr) {
          const prevMin = el._flatpickr.config.minDate;
          if (allowPast) el._flatpickr.set('minDate', null);
          if (ymd) el._flatpickr.setDate(ymd, true); else el._flatpickr.clear();
          if (allowPast) el._flatpickr.set('minDate', prevMin);
        } else {
          el.value = ymd || '';
        }
      }

      // --- canales (checkboxes con hidden espelho) ---
      function syncCanalHidden() {
        const g = $('#channelGroup');
        if (!g) return;
        $$('.chx-canal', g).forEach(chk => {
          const hid = g.querySelector(`input[type="hidden"][name="${chk.name}"]`);
          if (hid) hid.value = chk.checked ? 'true' : 'false';
        });
      }
      function setCanalesDisabled(disabled) {
        syncCanalHidden(); // primero sincroniza (disabled no envía)
        $$('#channelGroup .chx-canal').forEach(chk => chk.disabled = disabled);
      }

      // --- flags (GD / SC / SID) con hidden espejo + single-select ---
      function syncFlagHidden() {
        ['flagGD','flagSC','flagSID'].forEach(id => {
          const chk = document.getElementById(id);
          if (!chk) return;
          const hid = chk.parentElement.querySelector(`input[type="hidden"][name="${chk.name}"]`);
          if (hid) hid.value = chk.checked ? 'true' : 'false';
        });
      }
      function setFlagsDisabled(disabled) {
        syncFlagHidden();
        ['flagGD','flagSC','flagSID'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = disabled;
        });
      }

      function dedupeSelect(selectEl) {
        const seen = new Set();
        [...selectEl.options].forEach(opt => {
          const key = opt.value + '|' + opt.text;
          if (seen.has(key)) opt.remove(); else seen.add(key);
        });
      }

      // ===================== Carga de ticket (único handler) =====================
      let loadSeq = 0; // evita condiciones de carrera

      async function loadTicket(ticket) {
        const mySeq = ++loadSeq;
        const res = await fetch('@Url.Action("ObtenerControlTrafico", "GestionServicio")' + '?ticket=' + encodeURIComponent(ticket),
                                { headers: { 'Accept':'application/json' } });
        const d = await res.json();
        if (mySeq !== loadSeq) return;         // respuesta vieja
        if (!d.ok) { alert('No encontrado'); return; }

        // Modo edición
        $('#EstadoFormulario').value = 'Editar';
        document.querySelector('input[name="ticket"]').value = d.ticket ?? '';

        // Canales → set + bloquear (se enviarán por los hidden)
        const g = $('#channelGroup');
        g.querySelector('[name="CanalEmail"]').checked       = !!d.canalEmail;
        g.querySelector('[name="CanalWeb"]').checked         = !!d.canalWeb;
        g.querySelector('[name="CanalPresencial"]').checked  = !!d.canalPresencial;
        g.querySelector('[name="CanalTelefono"]').checked    = !!d.canalTelefono;
        g.querySelector('[name="CanalChatbot"]').checked     = !!d.canalChatbot;
        setCanalesDisabled(true);

        // Empresa → cargar contratos de ESA empresa → seleccionar contrato
        const selEmpresa  = $('#selectEmpresa');
        selEmpresa.value  = d.empresaId || '';
        await cargarContratosService(d.empresaId || '', d.contratoId || '');

        await window.cargarSolicitantes(d.empresaId || null, d.solicitanteId || '');

        // Por si el contrato no vino en la lista (pertenece a otra empresa, etc.)
        if (d.contratoId) {
          const selContrato = $('#selectContrato');
          if (selContrato.value !== d.contratoId) {
            const label = d.contratoLabel || d.contratoId;
            selContrato.add(new Option(label, d.contratoId), Math.min(1, selContrato.options.length));
            selContrato.value = d.contratoId;
            dedupeSelect(selContrato);
          }
        }

        // Otros selects simples
        setSelectValueSafe($('#selectSolicitante'),   d.solicitanteId || '');
        setSelectValueSafe($('#selectAsignado'),      d.asignadoAId || '');
        setSelectValueSafe($('#selectRazonServicio'), d.razonServicioId || '');


        // Radios + inputs
        const radio = document.querySelector(`input[name="LugarServicio"][value="${d.lugarServicio ?? 0}"]`);
        if (radio) radio.checked = true;
        $('#TelefonoServicio').value     = d.telefonoServicio ?? '';
        $('#EmailServicio').value        = d.emailServicio ?? '';
        $('#DireccionServicio').value    = d.direccionServicio ?? '';
        $('#DescripcionIncidente').value = d.descripcionIncidente ?? '';

        // Fecha / Hora
        setDateField('FechaProximoServicio', d.fechaProximoServicio, { allowPast:true });
        setTimeSelectValue(d.horaServicio || '');

        // Flags
        $('#flagGD')?.setAttribute('checked', (!!d.gd).toString());
        $('#flagSC')?.setAttribute('checked', (!!d.sc).toString());
        $('#flagSID')?.setAttribute('checked', (!!d.sid).toString());
        $('#flagGD').checked  = !!d.gd;
        $('#flagSC').checked  = !!d.sc;
        $('#flagSID').checked = !!d.sid;
        setFlagsDisabled(true);




      }

      // ===================== Wiring =====================
      document.addEventListener('DOMContentLoaded', () => {
        const form = $('#frmControlTrafico');

        // Canales: modo single-select + sincronizar hidden en cada cambio
        const canales = $$('#channelGroup .chx-canal');
        canales.forEach(ch => {
          ch.addEventListener('change', () => {
            if (ch.checked) canales.forEach(o => { if (o !== ch) o.checked = false; });
            syncCanalHidden();
          });
        });
        form?.addEventListener('submit', () => {
          syncCanalHidden();
          syncFlagHidden();
        });

        // Flags: single-select (GD/SC/SID)
        ['flagGD','flagSC','flagSID'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('change', () => {
            if (el.checked) {
              ['flagGD','flagSC','flagSID'].forEach(otro => {
                if (otro !== id) {
                  const chk = document.getElementById(otro);
                  if (chk) chk.checked = false;
                }
              });
            }
            syncFlagHidden();
          });
        });

        // Borrar / reset visual básico
        $('#btnBorrar')?.addEventListener('click', () => {
          setCanalesDisabled(false);
          canales.forEach(chk => chk.checked = false);
          syncCanalHidden();

          ['flagGD','flagSC','flagSID'].forEach(id => {
            const chk = document.getElementById(id);
            if (chk) chk.checked = false;
          });
          setFlagsDisabled(false);

          // si quieres limpiar el select de contrato cuando empresa se limpia, hazlo aquí
          // const selEmpresa = $('#selectEmpresa');
          // const selContrato = $('#selectContrato');
          // if (selEmpresa && !selEmpresa.value && selContrato) {
          //   selContrato.innerHTML = '';
          //   selContrato.append(new Option('Sin contrato',''));
          // }
        });

        // Cambio manual de empresa ⇒ cargar contratos de esa empresa (sin preselección)
        $('#selectEmpresa')?.addEventListener('change', e => {
          cargarContratosService(e.target.value, null);
        });

        // Dedupe dinámico por si el backend o edición reinyecta opciones
        const selContrato = $('#selectContrato');
        if (selContrato) {
          selContrato.addEventListener('change', () => dedupeSelect(selContrato));
          const obs = new MutationObserver(() => dedupeSelect(selContrato));
          obs.observe(selContrato, { childList: true });
        }
      });

      // Handler único delegado para Editar
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-edit');
        if (!btn) return;
        e.preventDefault();
        const ticket = btn.dataset.ticket;
        if (ticket) loadTicket(ticket);
      });
    })();
</script>




<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="~/js/control-trafico.js"></script>


<style>
    /* body {
                                                    background-color: #FFE2DA;

                                                } */


    .btn-orange {
        background-color: #FF5100;
        color: white;
    }

        .btn-orange:hover {
            background-color: #e46b0f;
            color: white;
        }

    .btn-outline-orange {
        background-color: #FF5100;
        color: white;
        border: none;
        transition: background-color 0.2s ease, color 0.2s ease;
    }

        .btn-outline-orange:hover {
            border: 1px solid #FFA45B;
            color: white;
            background-color: #FFA45B;
        }


    .select-light {
        background-color: #eeeeee;
    }

    h4 {
        color: #353535;
    }

</style>



<script>
    document.addEventListener('DOMContentLoaded', () => {
      const selEmpresa      = document.getElementById('selectEmpresa');
      const selSolicitante  = document.getElementById('selectSolicitante');

      async function cargarSolicitantes(empresaId, selectedValue) {
        // 1) reset
        selSolicitante.innerHTML = '';
        selSolicitante.append(new Option('Seleccione un elemento', ''));

        // 2) arma URL: si no hay empresa => trae todos
        const baseUrl = '@Url.Action("SolicitantesPorEmpresa", "GestionServicio")';
        const url = empresaId ? `${baseUrl}?empresaId=${encodeURIComponent(empresaId)}` : baseUrl;

        try {
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json(); // [{value,text}]

          // 3) poblar
          data.forEach(o => selSolicitante.append(new Option(o.text, o.value)));

          // 4) preselección (útil cuando estás editando)
          if (selectedValue) {
            selSolicitante.value = selectedValue;
            // por si no vino en la lista (poco probable si el contacto pertenece a otra empresa)
            if (selSolicitante.value !== selectedValue) {
              const label = 'Solicitante seleccionado';
              selSolicitante.add(new Option(label, selectedValue, true, true), 1);
              selSolicitante.value = selectedValue;
            }
          }
        } catch (e) {
          console.error('Error cargando solicitantes:', e);
          // deja solo el “Seleccione”
        }
      }

      // Cambio manual de empresa => filtra por esa empresa
      selEmpresa?.addEventListener('change', () => {
        const empId = selEmpresa.value || null;
        cargarSolicitantes(empId, null);
      });

      // Exponer para modo Edición (si ya tienes flujo de editar):
      window.cargarSolicitantes = cargarSolicitantes;

      // Estado inicial:
      // - Sin empresa seleccionada => ya tienes TODOS del ViewBag (no hacemos nada).
      // - Si quieres forzar a que siempre venga desde API, descomenta:
      // cargarSolicitantes(null, null);
    });
</script>

<script>
    (function () {
      const $ = (s) => document.querySelector(s);

      function selectSinAsignarDefault({ onlyIfInsert = true } = {}) {
        const sel = $('#selectAsignado');
        if (!sel) return;

        if (onlyIfInsert) {
          const estado = $('#EstadoFormulario')?.value?.toLowerCase() || 'insertar';
          if (estado !== 'insertar') return;
        }

        const pick = () => {
          const opt = [...sel.options].find(o =>
            (o.text || '').trim().toLowerCase().startsWith('sin asignar')
          );
          if (opt) sel.value = opt.value;
        };

        // si ya está la opción, seleccionar
        pick();

        // si aún no está (se llena async), observar una sola vez hasta que aparezca
        const hasSinAsignar = [...sel.options].some(o =>
          (o.text || '').trim().toLowerCase().startsWith('sin asignar')
        );
        if (!hasSinAsignar) {
          const obs = new MutationObserver(() => {
            const found = [...sel.options].some(o =>
              (o.text || '').trim().toLowerCase().startsWith('sin asignar')
            );
            if (found) { pick(); obs.disconnect(); }
          });
          obs.observe(sel, { childList: true });
          // safety: corta a los 5s para no dejar observer colgado
          setTimeout(() => obs.disconnect(), 5000);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        // 1) En carga inicial, si estamos en "Insertar", dejar "Sin Asignar"
        selectSinAsignarDefault({ onlyIfInsert: true });

        // 2) Después de BORRAR: ejecuta al final del tick para que gane
        $('#btnBorrar')?.addEventListener('click', () => {
          setTimeout(() => selectSinAsignarDefault({ onlyIfInsert: false }), 0);
        });
      });
    })();
</script>

